<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Vocabuild ‚Äî Smart Vocabulary Builder</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --grad-spanish: linear-gradient(135deg, #f7971e, #ffd200);
  --grad-french: linear-gradient(135deg, #667eea, #764ba2);
  --grad-arabic: linear-gradient(135deg, #11998e, #38ef7d);
  --grad-japanese: linear-gradient(135deg, #fc5c7d, #6a82fb);
  --grad-german: linear-gradient(135deg, #f857a6, #ff5858);
  --bg: #0f0f1a;
  --card-bg: #1a1a2e;
  --text: #e8e8f0;
  --text-dim: #8888aa;
  --accent: #667eea;
  --success: #38ef7d;
  --danger: #ff5858;
  --radius: 16px;
}
html,body{height:100%;font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);overflow-x:hidden;-webkit-tap-highlight-color:transparent}
.screen{display:none;min-height:100vh;padding:20px;max-width:480px;margin:0 auto;flex-direction:column}
.screen.active{display:flex}

/* Header */
.header{display:flex;justify-content:space-between;align-items:center;padding:8px 0;margin-bottom:16px}
.header h1{font-size:20px;font-weight:800;background:var(--grad-french);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.header-icons{display:flex;gap:12px}
.icon-btn{background:none;border:none;color:var(--text-dim);font-size:20px;cursor:pointer;padding:4px}
.icon-btn:hover{color:var(--text)}

/* Streak badge */
.streak-badge{display:inline-flex;align-items:center;gap:6px;background:rgba(255,255,255,0.05);border-radius:20px;padding:4px 12px;font-size:13px;font-weight:600;color:var(--text)}
.streak-badge .fire{font-size:16px}

/* Welcome */
#welcome{text-align:center;justify-content:center;gap:24px}
#welcome h1{font-size:36px;font-weight:900;background:var(--grad-french);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;line-height:1.2}
#welcome p{color:var(--text-dim);font-size:15px;line-height:1.6;max-width:320px;margin:0 auto}
.start-btn{background:var(--grad-french);border:none;color:#fff;font-size:16px;font-weight:700;padding:16px 48px;border-radius:50px;cursor:pointer;font-family:inherit;transition:transform .2s,box-shadow .2s;box-shadow:0 4px 24px rgba(102,126,234,0.4)}
.start-btn:hover{transform:scale(1.02)}
.start-btn:active{transform:scale(0.98)}

/* Language & Interest selection */
.selection-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:16px 0}
.sel-card{background:var(--card-bg);border:2px solid transparent;border-radius:var(--radius);padding:20px 16px;text-align:center;cursor:pointer;transition:all .2s;position:relative;overflow:hidden}
.sel-card::before{content:'';position:absolute;top:0;left:0;right:0;bottom:0;opacity:0;transition:opacity .2s}
.sel-card:hover::before,.sel-card.selected::before{opacity:0.15}
.sel-card.selected{border-color:var(--accent);box-shadow:0 0 20px rgba(102,126,234,0.2)}
.sel-card .emoji{font-size:32px;margin-bottom:8px;display:block}
.sel-card .label{font-size:14px;font-weight:600}
.sel-card .sublabel{font-size:11px;color:var(--text-dim);margin-top:2px}

/* Language colors on cards */
.sel-card[data-lang="spanish"]::before{background:var(--grad-spanish)}
.sel-card[data-lang="french"]::before{background:var(--grad-french)}
.sel-card[data-lang="arabic"]::before{background:var(--grad-arabic)}
.sel-card[data-lang="japanese"]::before{background:var(--grad-japanese)}
.sel-card[data-lang="german"]::before{background:var(--grad-german)}

/* Interest cards */
.sel-card[data-interest]::before{background:var(--grad-french)}

.section-title{font-size:22px;font-weight:800;margin:16px 0 4px}
.section-sub{color:var(--text-dim);font-size:13px;margin-bottom:12px}

/* Continue button */
.continue-btn{background:var(--card-bg);border:2px solid rgba(255,255,255,0.1);color:var(--text);font-size:15px;font-weight:700;padding:14px;border-radius:50px;cursor:pointer;font-family:inherit;transition:all .2s;margin-top:auto;margin-bottom:20px;width:100%}
.continue-btn.ready{background:var(--grad-french);border-color:transparent;box-shadow:0 4px 24px rgba(102,126,234,0.3)}
.continue-btn:disabled{opacity:0.4;cursor:not-allowed}

/* Flashcard */
.card-container{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px 0}
.card-progress{font-size:13px;color:var(--text-dim);margin-bottom:16px;text-align:center}
.card-wrapper{width:100%;max-width:360px;height:380px;perspective:1000px;cursor:pointer}
.card-inner{position:relative;width:100%;height:100%;transition:transform 0.6s cubic-bezier(0.4,0,0.2,1);transform-style:preserve-3d}
.card-inner.flipped{transform:rotateY(180deg)}
.card-front,.card-back{position:absolute;width:100%;height:100%;backface-visibility:hidden;-webkit-backface-visibility:hidden;border-radius:var(--radius);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:32px;text-align:center}
.card-front{background:var(--card-bg);border:1px solid rgba(255,255,255,0.08)}
.card-back{background:var(--card-bg);border:1px solid rgba(255,255,255,0.08);transform:rotateY(180deg)}
.card-word{font-size:42px;font-weight:900;margin-bottom:12px;line-height:1.2}
.card-pronunciation{font-size:15px;color:var(--text-dim);margin-bottom:16px;font-style:italic}
.card-translation{font-size:28px;font-weight:700;margin-bottom:16px}
.card-example{font-size:14px;color:var(--text-dim);line-height:1.6;max-width:280px}
.card-tap-hint{position:absolute;bottom:20px;font-size:12px;color:var(--text-dim);opacity:0.6}
.card-interest-tag{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:1px;padding:4px 12px;border-radius:20px;background:rgba(102,126,234,0.2);color:var(--accent);margin-bottom:8px}
.audio-btn{background:none;border:1px solid rgba(255,255,255,0.15);color:var(--text);width:40px;height:40px;border-radius:50%;cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center;margin-top:12px;transition:all .2s}
.audio-btn:hover{background:rgba(255,255,255,0.05);border-color:rgba(255,255,255,0.3)}

/* Rating buttons */
.rating-row{display:flex;gap:8px;padding:16px 0;width:100%;max-width:360px}
.rate-btn{flex:1;padding:14px 8px;border:none;border-radius:12px;font-family:inherit;font-size:12px;font-weight:700;cursor:pointer;transition:all .2s;text-transform:uppercase;letter-spacing:0.5px}
.rate-btn.again{background:rgba(255,88,88,0.15);color:#ff5858}
.rate-btn.hard{background:rgba(255,165,0,0.15);color:#ffa500}
.rate-btn.good{background:rgba(56,239,125,0.15);color:#38ef7d}
.rate-btn.easy{background:rgba(102,126,234,0.15);color:#667eea}
.rate-btn:hover{transform:scale(1.05)}
.rate-btn:active{transform:scale(0.95)}

/* Dashboard */
#dashboard{padding-bottom:40px}
.stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:16px 0}
.stat-card{background:var(--card-bg);border-radius:var(--radius);padding:20px;text-align:center}
.stat-number{font-size:32px;font-weight:900;margin-bottom:4px}
.stat-label{font-size:12px;color:var(--text-dim);text-transform:uppercase;letter-spacing:1px}
.stat-card.streak .stat-number{background:var(--grad-spanish);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.stat-card.learned .stat-number{color:var(--success)}
.stat-card.reviews .stat-number{color:var(--accent)}
.stat-card.accuracy .stat-number{background:var(--grad-japanese);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}

.progress-section{margin:24px 0}
.progress-section h3{font-size:14px;font-weight:700;margin-bottom:12px;text-transform:uppercase;letter-spacing:1px;color:var(--text-dim)}
.progress-bar-wrap{background:rgba(255,255,255,0.05);border-radius:10px;height:8px;overflow:hidden;margin-bottom:8px}
.progress-bar-fill{height:100%;border-radius:10px;transition:width .6s cubic-bezier(0.4,0,0.2,1)}
.progress-label{font-size:12px;color:var(--text-dim)}

.action-row{display:flex;gap:12px;margin:20px 0}
.action-btn{flex:1;padding:14px;border:1px solid rgba(255,255,255,0.1);background:var(--card-bg);color:var(--text);border-radius:var(--radius);font-family:inherit;font-size:14px;font-weight:600;cursor:pointer;transition:all .2s;text-align:center}
.action-btn:hover{background:rgba(255,255,255,0.05);border-color:rgba(255,255,255,0.2)}
.action-btn.primary{background:var(--grad-french);border-color:transparent;color:#fff}

/* Settings */
.settings-group{background:var(--card-bg);border-radius:var(--radius);padding:16px;margin:12px 0}
.settings-group h3{font-size:13px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text-dim);margin-bottom:12px}
.setting-item{display:flex;justify-content:between;align-items:center;padding:8px 0}
.setting-item label{flex:1;font-size:14px}
.setting-item select{background:rgba(255,255,255,0.05);color:var(--text);border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:6px 12px;font-family:inherit;font-size:13px}
.danger-zone{margin-top:32px}
.danger-btn{background:rgba(255,88,88,0.1);border:1px solid rgba(255,88,88,0.2);color:#ff5858;padding:12px;border-radius:var(--radius);font-family:inherit;font-size:14px;font-weight:600;cursor:pointer;width:100%}

/* Session complete */
.session-complete{text-align:center;flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px}
.session-complete .big-emoji{font-size:64px}
.session-complete h2{font-size:24px;font-weight:800}
.session-complete p{color:var(--text-dim);font-size:14px;line-height:1.6}

/* Language gradient applied dynamically */
.lang-gradient{background:var(--current-grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}

/* Back button */
.back-btn{background:none;border:none;color:var(--text-dim);font-size:14px;cursor:pointer;padding:8px 0;font-family:inherit;display:flex;align-items:center;gap:4px}
.back-btn:hover{color:var(--text)}

/* Animations */
@keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.animate-in{animation:slideUp .4s ease-out}

/* Scroll */
.screen{overflow-y:auto}
.screen::-webkit-scrollbar{display:none}
</style>
</head>
<body>

<!-- Welcome Screen -->
<div id="welcome" class="screen active">
  <div>
    <div style="font-size:48px;margin-bottom:16px">üåç</div>
    <h1>Vocabuild</h1>
    <p>Learn any language through spaced repetition, personalized to your interests.</p>
  </div>
  <button class="start-btn" onclick="showScreen('setup-lang')">Get Started</button>
  <div id="welcome-continue" style="display:none;margin-top:12px">
    <button class="start-btn" style="background:var(--card-bg);box-shadow:none;border:1px solid rgba(255,255,255,0.15)" onclick="resumeSession()">Continue Learning</button>
  </div>
</div>

<!-- Language Selection -->
<div id="setup-lang" class="screen">
  <button class="back-btn" onclick="showScreen('welcome')">‚Üê Back</button>
  <h2 class="section-title">Choose your language</h2>
  <p class="section-sub">What do you want to learn?</p>
  <div class="selection-grid">
    <div class="sel-card" data-lang="spanish" onclick="selectLang(this)">
      <span class="emoji">üá™üá∏</span>
      <div class="label">Spanish</div>
      <div class="sublabel">100 words</div>
    </div>
    <div class="sel-card" data-lang="french" onclick="selectLang(this)">
      <span class="emoji">üá´üá∑</span>
      <div class="label">French</div>
      <div class="sublabel">50 words</div>
    </div>
    <div class="sel-card" data-lang="arabic" onclick="selectLang(this)">
      <span class="emoji">üá∏üá¶</span>
      <div class="label">Arabic</div>
      <div class="sublabel">50 words</div>
    </div>
    <div class="sel-card" data-lang="japanese" onclick="selectLang(this)">
      <span class="emoji">üáØüáµ</span>
      <div class="label">Japanese</div>
      <div class="sublabel">50 words</div>
    </div>
    <div class="sel-card" data-lang="german" onclick="selectLang(this)">
      <span class="emoji">üá©üá™</span>
      <div class="label">German</div>
      <div class="sublabel">50 words</div>
    </div>
  </div>
  <button class="continue-btn" id="lang-continue" disabled onclick="showScreen('setup-interest')">Continue</button>
</div>

<!-- Interest Selection -->
<div id="setup-interest" class="screen">
  <button class="back-btn" onclick="showScreen('setup-lang')">‚Üê Back</button>
  <h2 class="section-title">Choose your interest</h2>
  <p class="section-sub">Get example sentences tailored to you</p>
  <div class="selection-grid">
    <div class="sel-card" data-interest="business" onclick="selectInterest(this)">
      <span class="emoji">üíº</span>
      <div class="label">Business</div>
    </div>
    <div class="sel-card" data-interest="travel" onclick="selectInterest(this)">
      <span class="emoji">‚úàÔ∏è</span>
      <div class="label">Travel</div>
    </div>
    <div class="sel-card" data-interest="food" onclick="selectInterest(this)">
      <span class="emoji">üçï</span>
      <div class="label">Food</div>
    </div>
    <div class="sel-card" data-interest="tech" onclick="selectInterest(this)">
      <span class="emoji">üíª</span>
      <div class="label">Tech</div>
    </div>
    <div class="sel-card" data-interest="sports" onclick="selectInterest(this)">
      <span class="emoji">‚öΩ</span>
      <div class="label">Sports</div>
    </div>
    <div class="sel-card" data-interest="daily" onclick="selectInterest(this)">
      <span class="emoji">‚òÄÔ∏è</span>
      <div class="label">Daily Life</div>
    </div>
  </div>
  <button class="continue-btn" id="interest-continue" disabled onclick="startLearning()">Start Learning</button>
</div>

<!-- Study Screen -->
<div id="study" class="screen">
  <div class="header">
    <h1>Vocabuild</h1>
    <div class="header-icons">
      <div class="streak-badge"><span class="fire">üî•</span><span id="header-streak">0</span></div>
      <button class="icon-btn" onclick="showScreen('dashboard')" title="Dashboard">üìä</button>
      <button class="icon-btn" onclick="showScreen('settings')" title="Settings">‚öôÔ∏è</button>
    </div>
  </div>
  <div class="card-progress" id="card-progress">Card 1 of 10</div>
  <div class="card-container">
    <div class="card-wrapper" onclick="flipCard()">
      <div class="card-inner" id="card-inner">
        <div class="card-front" id="card-front">
          <div class="card-word" id="card-word">‚Äî</div>
          <div class="card-pronunciation" id="card-pronunciation">‚Äî</div>
          <button class="audio-btn" onclick="event.stopPropagation();playAudio()" title="Listen">üîä</button>
          <div class="card-tap-hint">Tap to reveal</div>
        </div>
        <div class="card-back" id="card-back">
          <div class="card-interest-tag" id="card-interest-tag">DAILY</div>
          <div class="card-translation" id="card-translation">‚Äî</div>
          <div class="card-example" id="card-example">‚Äî</div>
          <button class="audio-btn" onclick="event.stopPropagation();playAudio()" title="Listen">üîä</button>
        </div>
      </div>
    </div>
  </div>
  <div class="rating-row" id="rating-row" style="display:none">
    <button class="rate-btn again" onclick="rateCard(0)">Again</button>
    <button class="rate-btn hard" onclick="rateCard(3)">Hard</button>
    <button class="rate-btn good" onclick="rateCard(4)">Good</button>
    <button class="rate-btn easy" onclick="rateCard(5)">Easy</button>
  </div>
</div>

<!-- Session Complete -->
<div id="complete" class="screen">
  <div class="header">
    <h1>Vocabuild</h1>
    <div class="header-icons">
      <button class="icon-btn" onclick="showScreen('dashboard')">üìä</button>
      <button class="icon-btn" onclick="showScreen('settings')">‚öôÔ∏è</button>
    </div>
  </div>
  <div class="session-complete animate-in">
    <div class="big-emoji">üéâ</div>
    <h2>Session Complete!</h2>
    <p id="complete-stats">You reviewed 10 cards today. Keep up the streak!</p>
    <div style="margin-top:20px;display:flex;gap:12px;width:100%;max-width:320px">
      <button class="action-btn" onclick="showScreen('dashboard')">Dashboard</button>
      <button class="action-btn primary" onclick="startSession()">Study More</button>
    </div>
  </div>
</div>

<!-- Dashboard -->
<div id="dashboard" class="screen">
  <div class="header">
    <h1>Vocabuild</h1>
    <div class="header-icons">
      <button class="icon-btn" onclick="showScreen('settings')">‚öôÔ∏è</button>
    </div>
  </div>
  <button class="back-btn" onclick="showScreen('study')" id="dash-back">‚Üê Back to study</button>
  <div class="stat-grid">
    <div class="stat-card streak">
      <div class="stat-number" id="dash-streak">0</div>
      <div class="stat-label">Day Streak</div>
    </div>
    <div class="stat-card learned">
      <div class="stat-number" id="dash-learned">0</div>
      <div class="stat-label">Words Learned</div>
    </div>
    <div class="stat-card reviews">
      <div class="stat-number" id="dash-reviews">0</div>
      <div class="stat-label">Total Reviews</div>
    </div>
    <div class="stat-card accuracy">
      <div class="stat-number" id="dash-accuracy">0%</div>
      <div class="stat-label">Accuracy</div>
    </div>
  </div>
  <div class="progress-section">
    <h3>Vocabulary Progress</h3>
    <div class="progress-bar-wrap">
      <div class="progress-bar-fill" id="dash-progress" style="width:0%;background:var(--grad-french)"></div>
    </div>
    <div class="progress-label" id="dash-progress-label">0 / 100 words</div>
  </div>
  <div class="progress-section">
    <h3>Due for Review</h3>
    <div style="font-size:32px;font-weight:900;color:var(--accent)" id="dash-due">0</div>
    <div class="progress-label">words due today</div>
  </div>
  <div class="action-row">
    <button class="action-btn primary" onclick="startSession()">Study Now</button>
  </div>
</div>

<!-- Settings -->
<div id="settings" class="screen">
  <div class="header">
    <h1>Settings</h1>
  </div>
  <button class="back-btn" onclick="goBack()">‚Üê Back</button>
  <div class="settings-group">
    <h3>Preferences</h3>
    <div class="setting-item">
      <label>Language</label>
      <select id="set-lang" onchange="changeLang(this.value)"></select>
    </div>
    <div class="setting-item">
      <label>Interest</label>
      <select id="set-interest" onchange="changeInterest(this.value)">
        <option value="business">Business</option>
        <option value="travel">Travel</option>
        <option value="food">Food</option>
        <option value="tech">Tech</option>
        <option value="sports">Sports</option>
        <option value="daily">Daily Life</option>
      </select>
    </div>
    <div class="setting-item">
      <label>Cards per session</label>
      <select id="set-cards" onchange="changeCardsPerSession(this.value)">
        <option value="5">5</option>
        <option value="10" selected>10</option>
        <option value="15">15</option>
        <option value="20">20</option>
      </select>
    </div>
  </div>
  <div class="danger-zone">
    <button class="danger-btn" onclick="resetProgress()">Reset All Progress</button>
  </div>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ
let wordData = {};
let state = {
  lang: null,
  interest: null,
  cardsPerSession: 10,
  streak: 0,
  lastStudyDate: null,
  totalReviews: 0,
  correctReviews: 0,
  words: {} // { "spanish": { "hola": { ef:2.5, interval:0, repetitions:0, nextReview: "2025-01-01" } } }
};
let currentSession = [];
let currentCardIndex = 0;
let isFlipped = false;
let previousScreen = 'study';

const LANG_NAMES = {spanish:'Spanish',french:'French',arabic:'Arabic',japanese:'Japanese',german:'German'};
const LANG_VOICES = {spanish:'es',french:'fr',arabic:'ar',japanese:'ja',german:'de'};
const LANG_GRADS = {
  spanish:'linear-gradient(135deg, #f7971e, #ffd200)',
  french:'linear-gradient(135deg, #667eea, #764ba2)',
  arabic:'linear-gradient(135deg, #11998e, #38ef7d)',
  japanese:'linear-gradient(135deg, #fc5c7d, #6a82fb)',
  german:'linear-gradient(135deg, #f857a6, #ff5858)'
};

// ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ
async function init() {
  loadState();
  try {
    const resp = await fetch('words.json');
    wordData = await resp.json();
  } catch(e) {
    console.error('Failed to load words:', e);
  }
  if (state.lang && state.interest) {
    document.getElementById('welcome-continue').style.display = 'block';
    applyLangTheme();
  }
  updateStreak();
  populateSettings();
}

function loadState() {
  const saved = localStorage.getItem('vocabuild_state');
  if (saved) {
    const parsed = JSON.parse(saved);
    state = {...state, ...parsed};
  }
}

function saveState() {
  localStorage.setItem('vocabuild_state', JSON.stringify(state));
}

// ‚îÄ‚îÄ‚îÄ Navigation ‚îÄ‚îÄ‚îÄ
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if (id === 'dashboard') updateDashboard();
  if (id === 'settings') populateSettings();
  if (id !== 'settings') previousScreen = id;
}

function goBack() {
  showScreen(previousScreen || 'study');
}

function resumeSession() {
  startSession();
}

// ‚îÄ‚îÄ‚îÄ Selection ‚îÄ‚îÄ‚îÄ
function selectLang(el) {
  document.querySelectorAll('[data-lang]').forEach(c => c.classList.remove('selected'));
  el.classList.add('selected');
  state.lang = el.dataset.lang;
  const btn = document.getElementById('lang-continue');
  btn.disabled = false;
  btn.classList.add('ready');
  saveState();
}

function selectInterest(el) {
  document.querySelectorAll('[data-interest]').forEach(c => c.classList.remove('selected'));
  el.classList.add('selected');
  state.interest = el.dataset.interest;
  const btn = document.getElementById('interest-continue');
  btn.disabled = false;
  btn.classList.add('ready');
  saveState();
}

// ‚îÄ‚îÄ‚îÄ Learning ‚îÄ‚îÄ‚îÄ
function startLearning() {
  applyLangTheme();
  initWordProgress();
  startSession();
}

function applyLangTheme() {
  document.documentElement.style.setProperty('--current-grad', LANG_GRADS[state.lang] || LANG_GRADS.french);
}

function initWordProgress() {
  if (!state.words[state.lang]) {
    state.words[state.lang] = {};
  }
  const words = wordData[state.lang] || [];
  words.forEach(w => {
    if (!state.words[state.lang][w.word]) {
      state.words[state.lang][w.word] = {
        ef: 2.5, interval: 0, repetitions: 0, nextReview: null, learned: false
      };
    }
  });
  saveState();
}

function startSession() {
  if (!state.lang || !wordData[state.lang]) return;
  initWordProgress();
  const today = getToday();
  const langWords = state.words[state.lang];
  const allWords = wordData[state.lang];

  // Get due words
  let dueWords = allWords.filter(w => {
    const prog = langWords[w.word];
    return prog && prog.nextReview && prog.nextReview <= today;
  });

  // Get new words (not yet studied)
  let newWords = allWords.filter(w => {
    const prog = langWords[w.word];
    return prog && !prog.nextReview;
  });

  // Build session: due first, then new to fill
  currentSession = [];
  const maxCards = state.cardsPerSession;

  // Add due words
  dueWords.sort(() => Math.random() - 0.5);
  currentSession.push(...dueWords.slice(0, maxCards));

  // Fill with new words
  const remaining = maxCards - currentSession.length;
  if (remaining > 0) {
    currentSession.push(...newWords.slice(0, remaining));
  }

  // If still empty, restudy random words
  if (currentSession.length === 0) {
    const studied = allWords.filter(w => langWords[w.word] && langWords[w.word].nextReview);
    studied.sort(() => Math.random() - 0.5);
    currentSession.push(...studied.slice(0, maxCards));
  }

  if (currentSession.length === 0) return;

  currentCardIndex = 0;
  showScreen('study');
  showCard();
}

function showCard() {
  if (currentCardIndex >= currentSession.length) {
    finishSession();
    return;
  }

  const word = currentSession[currentCardIndex];
  const progress = document.getElementById('card-progress');
  progress.textContent = `Card ${currentCardIndex + 1} of ${currentSession.length}`;

  document.getElementById('card-word').textContent = word.word;
  document.getElementById('card-pronunciation').textContent = word.pronunciation;
  document.getElementById('card-translation').textContent = word.translation;

  const interest = state.interest || 'daily';
  document.getElementById('card-interest-tag').textContent = interest.toUpperCase();
  document.getElementById('card-example').textContent = word.sentences[interest] || word.sentences.daily;

  // Apply gradient to word
  const wordEl = document.getElementById('card-word');
  wordEl.style.background = LANG_GRADS[state.lang];
  wordEl.style.webkitBackgroundClip = 'text';
  wordEl.style.webkitTextFillColor = 'transparent';
  wordEl.style.backgroundClip = 'text';

  // Reset flip
  document.getElementById('card-inner').classList.remove('flipped');
  document.getElementById('rating-row').style.display = 'none';
  isFlipped = false;

  // Update streak display
  document.getElementById('header-streak').textContent = state.streak;
}

function flipCard() {
  const inner = document.getElementById('card-inner');
  if (!isFlipped) {
    inner.classList.add('flipped');
    isFlipped = true;
    document.getElementById('rating-row').style.display = 'flex';
  }
}

// ‚îÄ‚îÄ‚îÄ SM-2 Algorithm ‚îÄ‚îÄ‚îÄ
function rateCard(quality) {
  const word = currentSession[currentCardIndex];
  const prog = state.words[state.lang][word.word];

  state.totalReviews++;
  if (quality >= 3) state.correctReviews++;

  // SM-2
  if (quality < 3) {
    prog.repetitions = 0;
    prog.interval = 1;
  } else {
    if (prog.repetitions === 0) {
      prog.interval = 1;
    } else if (prog.repetitions === 1) {
      prog.interval = 6;
    } else {
      prog.interval = Math.round(prog.interval * prog.ef);
    }
    prog.repetitions++;
  }

  prog.ef = Math.max(1.3, prog.ef + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02)));
  prog.nextReview = addDays(getToday(), prog.interval);
  prog.learned = prog.repetitions >= 1;

  saveState();
  currentCardIndex++;
  showCard();
}

// ‚îÄ‚îÄ‚îÄ Session Complete ‚îÄ‚îÄ‚îÄ
function finishSession() {
  // Update streak
  const today = getToday();
  if (state.lastStudyDate !== today) {
    const yesterday = addDays(today, -1);
    if (state.lastStudyDate === yesterday || !state.lastStudyDate) {
      state.streak++;
    } else {
      state.streak = 1;
    }
    state.lastStudyDate = today;
  }
  saveState();

  const reviewed = currentSession.length;
  document.getElementById('complete-stats').textContent =
    `You reviewed ${reviewed} cards. ${state.streak} day streak! üî•`;
  showScreen('complete');
}

// ‚îÄ‚îÄ‚îÄ Dashboard ‚îÄ‚îÄ‚îÄ
function updateDashboard() {
  if (!state.lang) return;
  const langWords = state.words[state.lang] || {};
  const allWords = wordData[state.lang] || [];
  const today = getToday();

  const learned = Object.values(langWords).filter(w => w.learned).length;
  const due = Object.values(langWords).filter(w => w.nextReview && w.nextReview <= today).length;
  const total = allWords.length;
  const accuracy = state.totalReviews > 0 ? Math.round((state.correctReviews / state.totalReviews) * 100) : 0;

  document.getElementById('dash-streak').textContent = state.streak;
  document.getElementById('dash-learned').textContent = learned;
  document.getElementById('dash-reviews').textContent = state.totalReviews;
  document.getElementById('dash-accuracy').textContent = accuracy + '%';
  document.getElementById('dash-due').textContent = due;
  document.getElementById('dash-progress').style.width = (total > 0 ? (learned / total * 100) : 0) + '%';
  document.getElementById('dash-progress-label').textContent = `${learned} / ${total} words`;
}

// ‚îÄ‚îÄ‚îÄ Audio ‚îÄ‚îÄ‚îÄ
function playAudio() {
  if (!currentSession[currentCardIndex]) return;
  const word = currentSession[currentCardIndex].word;
  const lang = LANG_VOICES[state.lang] || 'en';
  try {
    const utter = new SpeechSynthesisUtterance(word);
    utter.lang = lang;
    utter.rate = 0.8;
    speechSynthesis.speak(utter);
  } catch(e) { /* fallback: no audio */ }
}

// ‚îÄ‚îÄ‚îÄ Settings ‚îÄ‚îÄ‚îÄ
function populateSettings() {
  const langSel = document.getElementById('set-lang');
  langSel.innerHTML = Object.entries(LANG_NAMES).map(([k,v]) =>
    `<option value="${k}" ${k===state.lang?'selected':''}>${v}</option>`
  ).join('');
  document.getElementById('set-interest').value = state.interest || 'daily';
  document.getElementById('set-cards').value = state.cardsPerSession;
}

function changeLang(val) {
  state.lang = val;
  applyLangTheme();
  initWordProgress();
  saveState();
}

function changeInterest(val) {
  state.interest = val;
  saveState();
}

function changeCardsPerSession(val) {
  state.cardsPerSession = parseInt(val);
  saveState();
}

function resetProgress() {
  if (confirm('Reset all progress? This cannot be undone.')) {
    localStorage.removeItem('vocabuild_state');
    location.reload();
  }
}

// ‚îÄ‚îÄ‚îÄ Streak ‚îÄ‚îÄ‚îÄ
function updateStreak() {
  if (!state.lastStudyDate) return;
  const today = getToday();
  const yesterday = addDays(today, -1);
  if (state.lastStudyDate !== today && state.lastStudyDate !== yesterday) {
    state.streak = 0;
    saveState();
  }
}

// ‚îÄ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ
function getToday() {
  return new Date().toISOString().split('T')[0];
}

function addDays(dateStr, days) {
  const d = new Date(dateStr);
  d.setDate(d.getDate() + days);
  return d.toISOString().split('T')[0];
}

// ‚îÄ‚îÄ‚îÄ Keyboard ‚îÄ‚îÄ‚îÄ
document.addEventListener('keydown', e => {
  if (document.getElementById('study').classList.contains('active')) {
    if (e.code === 'Space') { e.preventDefault(); flipCard(); }
    if (isFlipped) {
      if (e.key === '1') rateCard(0);
      if (e.key === '2') rateCard(3);
      if (e.key === '3') rateCard(4);
      if (e.key === '4') rateCard(5);
    }
  }
});

// ‚îÄ‚îÄ‚îÄ Start ‚îÄ‚îÄ‚îÄ
init();
</script>
</body>
</html>
